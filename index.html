<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>her</title>
  <link rel="stylesheet" href="docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>her</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p> <strong>her</strong> is an easy to use deployment tool. It assumes that you are using nginx
 together with <a href='http://google.com?q=unicorn'>unicorn</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <h3>Workflow</h3>

<pre><code>her init
</code></pre>

<p> (this generates all configuration files in config folder of your project)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p> FileUtils are used to initialize <em>her</em> in the project directory</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="sx">%w{fileutils}</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">lib</span><span class="o">|</span> <span class="nb">require</span> <span class="n">lib</span> <span class="p">}</span>

<span class="n">lib</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../lib&#39;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">))</span>
<span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span> <span class="n">lib</span> <span class="k">unless</span> <span class="vg">$:</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
<span class="nb">require</span> <span class="s1">&#39;her/version&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p> Tty class is inspired by Homebrew Tty class. It is used for almost all output.</p>

<p> <code>onoe</code> prints an error if one arose.
 <code>okay</code> tries to execute a block</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Tty</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">onoe</span> <span class="n">error</span>
      <span class="n">lines</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">split</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">red</span><span class="si">}</span><span class="s2">Error</span><span class="si">#{</span><span class="n">reset</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">lines</span><span class="o">.</span><span class="n">shift</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="nb">puts</span> <span class="o">*</span><span class="n">lines</span> <span class="k">unless</span> <span class="n">lines</span><span class="o">.</span><span class="n">empty?</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">okay</span> <span class="n">title</span>
      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">blue</span><span class="si">}</span><span class="s2">==&gt;</span><span class="si">#{</span><span class="n">white</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">title</span><span class="si">}#{</span><span class="n">reset</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">yield</span> <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">error</span>
      <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">red</span><span class="si">}</span><span class="s2">Error</span><span class="si">#{</span><span class="n">reset</span><span class="si">}</span><span class="s2">: &quot;</span>
      <span class="k">raise</span> <span class="n">error</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">blue</span><span class="p">;</span> <span class="n">bold</span> <span class="mi">34</span><span class="p">;</span> <span class="k">end</span>
    <span class="k">def</span> <span class="nf">white</span><span class="p">;</span> <span class="n">bold</span> <span class="mi">39</span><span class="p">;</span> <span class="k">end</span>
    <span class="k">def</span> <span class="nf">red</span><span class="p">;</span> <span class="n">underline</span> <span class="mi">31</span><span class="p">;</span> <span class="k">end</span>
    <span class="k">def</span> <span class="nf">yellow</span><span class="p">;</span> <span class="n">escape</span> <span class="mi">33</span> <span class="p">;</span> <span class="k">end</span>
    <span class="k">def</span> <span class="nf">green</span><span class="p">;</span> <span class="n">escape</span> <span class="mi">32</span> <span class="p">;</span> <span class="k">end</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">;</span> <span class="n">escape</span> <span class="mi">0</span><span class="p">;</span> <span class="k">end</span>
    <span class="k">def</span> <span class="nf">em</span><span class="p">;</span> <span class="n">underline</span> <span class="mi">39</span><span class="p">;</span> <span class="k">end</span>
    <span class="k">def</span> <span class="nf">color</span> <span class="n">n</span><span class="p">;</span> <span class="n">escape</span> <span class="s2">&quot;0;</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">end</span>
    <span class="k">def</span> <span class="nf">bold</span> <span class="n">n</span><span class="p">;</span> <span class="n">escape</span> <span class="s2">&quot;1;</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">end</span>
    <span class="k">def</span> <span class="nf">underline</span> <span class="n">n</span><span class="p">;</span> <span class="n">escape</span> <span class="s2">&quot;4;</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">end</span>
    <span class="k">def</span> <span class="nf">escape</span> <span class="n">n</span><span class="p">;</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">m&quot;</span> <span class="k">if</span> <span class="vg">$stdout</span><span class="o">.</span><span class="n">tty?</span><span class="p">;</span> <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">Her</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p> options:</p>

<ul>
<li> :raw    &ndash; (bool)    don&rsquo;t prepend &ldquo;cd #{deploy_base}/#{app_name}; &rdquo;</li>
<li> :data   &ndash; (string)  send data to STDIN when asked</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">q</span> <span class="o">=</span> <span class="sx">%Q{cd </span><span class="si">#{</span><span class="n">deploy_base</span><span class="si">}</span><span class="sx">/</span><span class="si">#{</span><span class="n">app_name</span><span class="si">}</span><span class="sx">; </span><span class="si">#{</span><span class="n">q</span><span class="si">}</span><span class="sx">}</span> <span class="k">unless</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:raw</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">&quot;==&gt; </span><span class="si">#{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">visual_mode</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:data</span><span class="o">]</span>
      <span class="n">f</span> <span class="o">=</span> <span class="no">IO</span><span class="o">::</span><span class="n">popen</span> <span class="sx">%Q{ssh -q -p </span><span class="si">#{</span><span class="n">server_port</span><span class="si">}</span><span class="sx"> </span><span class="si">#{</span><span class="n">server_user</span><span class="si">}</span><span class="sx">@</span><span class="si">#{</span><span class="n">server</span><span class="si">}</span><span class="sx"> &quot;</span><span class="si">#{</span><span class="n">q</span><span class="si">}</span><span class="sx">&quot;}</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span>
      <span class="n">f</span><span class="o">.</span><span class="n">print</span> <span class="n">options</span><span class="o">[</span><span class="ss">:data</span><span class="o">]</span>
      <span class="n">f</span><span class="o">.</span><span class="n">close</span>
      <span class="vg">$?</span><span class="o">.</span><span class="n">success?</span> <span class="ow">or</span> <span class="k">raise</span> <span class="s2">&quot;Error executing: </span><span class="si">#{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="nb">system</span> <span class="sx">%Q{ssh -q -t -p </span><span class="si">#{</span><span class="n">server_port</span><span class="si">}</span><span class="sx"> </span><span class="si">#{</span><span class="n">server_user</span><span class="si">}</span><span class="sx">@</span><span class="si">#{</span><span class="n">server</span><span class="si">}</span><span class="sx"> &quot;</span><span class="si">#{</span><span class="n">q</span><span class="si">}</span><span class="sx">&quot;}</span> <span class="ow">or</span>
        <span class="k">raise</span> <span class="s2">&quot;Error executing: </span><span class="si">#{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">run?</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{});</span> <span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">options</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">false</span><span class="p">;</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nf">sudo</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{});</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;sudo &#39;</span><span class="si">#{</span><span class="n">q</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">);</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nf">load_configurations!</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p> Defaults</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">server_port</span>       <span class="mi">22</span>
    <span class="n">server_user</span>       <span class="s2">&quot;www&quot;</span>
    <span class="n">deploy_base</span>       <span class="s2">&quot;/var/www&quot;</span>
    <span class="n">nginx_bin</span>         <span class="s2">&quot;/etc/init.d/nginx&quot;</span>
    <span class="n">nginx_config</span>      <span class="s2">&quot;/etc/nginx/sites-enabled&quot;</span>
    <span class="n">rails</span>             <span class="kp">true</span>
    <span class="n">is_first_deploy</span>   <span class="kp">false</span>
    <span class="n">branch</span>            <span class="s2">&quot;master&quot;</span>
    <span class="n">env</span>               <span class="s2">&quot;production&quot;</span>

    <span class="nb">load</span> <span class="s2">&quot;./config/her.rb&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">exec!</span> <span class="n">args</span>
    <span class="n">visual_mode</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">eql?</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">)</span>

    <span class="k">case</span> <span class="n">args</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">when</span> <span class="s2">&quot;help&quot;</span><span class="p">,</span><span class="s2">&quot;h&quot;</span><span class="p">,</span><span class="kp">nil</span><span class="p">;</span> <span class="nb">puts</span> <span class="n">her_files</span><span class="o">[</span><span class="ss">:help</span><span class="o">].</span><span class="n">chomp</span>
    <span class="k">when</span> <span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">;</span> <span class="nb">puts</span> <span class="no">Her</span><span class="o">::</span><span class="no">VERSION</span>
    <span class="k">when</span> <span class="s2">&quot;init&quot;</span><span class="p">,</span><span class="s2">&quot;i&quot;</span>

      <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">)</span>
      <span class="o">[</span><span class="s2">&quot;unicorn.rb&quot;</span><span class="p">,</span> <span class="s2">&quot;her.rb&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
        <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;config/</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
          <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="no">Tty</span><span class="o">.</span><span class="n">yellow</span><span class="si">}</span><span class="s2">exists</span><span class="si">#{</span><span class="no">Tty</span><span class="o">.</span><span class="n">reset</span><span class="si">}</span><span class="s2">  config/</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span>
          <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;config/</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">){</span><span class="o">|</span><span class="n">f</span><span class="o">|</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">her_files</span><span class="o">[</span><span class="n">file</span><span class="o">.</span><span class="n">to_sym</span><span class="o">].</span><span class="n">chomp</span><span class="p">)}</span>
          <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="no">Tty</span><span class="o">.</span><span class="n">green</span><span class="si">}</span><span class="s2">create</span><span class="si">#{</span><span class="no">Tty</span><span class="o">.</span><span class="n">reset</span><span class="si">}</span><span class="s2">  config/</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>

    <span class="k">when</span> <span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span>

      <span class="n">load_configurations!</span>

      <span class="n">run</span> <span class="n">args</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="k">when</span> <span class="s2">&quot;deploy&quot;</span><span class="p">,</span><span class="s2">&quot;d&quot;</span>

      <span class="no">Tty</span><span class="o">.</span><span class="n">okay</span> <span class="s2">&quot;Reading configuration file&quot;</span> <span class="k">do</span>

        <span class="n">load_configurations!</span>

      <span class="k">end</span>

      <span class="no">Tty</span><span class="o">.</span><span class="n">okay</span> <span class="s2">&quot;Connecting to </span><span class="si">#{</span><span class="n">server</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
        <span class="k">unless</span> <span class="n">run?</span><span class="p">(</span><span class="s2">&quot;[[ -e </span><span class="si">#{</span><span class="n">deploy_base</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">app_name</span><span class="si">}</span><span class="s2"> ]]&quot;</span><span class="p">,</span> <span class="ss">:raw</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
          <span class="n">run</span> <span class="s2">&quot;&quot;</span>
          <span class="n">run</span> <span class="s2">&quot;mkdir -p </span><span class="si">#{</span><span class="n">deploy_base</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">app_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">:raw</span> <span class="o">=&gt;</span> <span class="kp">true</span>
          <span class="n">is_first_deploy</span> <span class="kp">true</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="no">Tty</span><span class="o">.</span><span class="n">okay</span> <span class="s2">&quot;Uploading nginx configuration&quot;</span> <span class="k">do</span>
        <span class="n">run</span> <span class="s2">&quot;cat &gt; </span><span class="si">#{</span><span class="n">nginx_config</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">app_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
          <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">her_files</span><span class="o">[</span><span class="ss">:nginx_config</span><span class="o">].</span><span class="n">chomp</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">),</span>
          <span class="ss">:raw</span> <span class="o">=&gt;</span> <span class="kp">true</span>
      <span class="k">end</span>                                             <span class="k">if</span> <span class="n">is_first_deploy</span>
      <span class="no">Tty</span><span class="o">.</span><span class="n">okay</span> <span class="s2">&quot;Cloning repository&quot;</span> <span class="k">do</span>
        <span class="n">run</span> <span class="s2">&quot;/usr/local/bin/git clone </span><span class="si">#{</span><span class="n">repository</span><span class="si">}</span><span class="s2"> . &amp;&amp; /usr/local/bin/git checkout -b her_deployment -t origin/</span><span class="si">#{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>                                             <span class="k">if</span> <span class="n">is_first_deploy</span>

      <span class="no">Tty</span><span class="o">.</span><span class="n">okay</span> <span class="s2">&quot;Pulling code changes&quot;</span> <span class="k">do</span>
        <span class="n">run</span> <span class="s2">&quot;/usr/local/bin/git pull </span><span class="si">#{</span><span class="n">repository</span><span class="si">}</span><span class="s2"> . &amp;&amp; /usr/local/bin/git pull origin </span><span class="si">#{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>                                             <span class="k">unless</span> <span class="n">is_first_deploy</span>

      <span class="no">Tty</span><span class="o">.</span><span class="n">okay</span> <span class="s2">&quot;Running on_first_deploy callback&quot;</span> <span class="k">do</span>
        <span class="n">on_first_deploy</span><span class="o">.</span><span class="n">call</span>
      <span class="k">end</span>                                             <span class="k">if</span> <span class="n">is_first_deploy</span>

      <span class="no">Tty</span><span class="o">.</span><span class="n">okay</span> <span class="s2">&quot;Running on_deploy callback&quot;</span> <span class="k">do</span>
        <span class="n">on_deploy</span><span class="o">.</span><span class="n">call</span>
      <span class="k">end</span>

      <span class="no">Tty</span><span class="o">.</span><span class="n">okay</span> <span class="s2">&quot;Starting unicorn&quot;</span> <span class="k">do</span>
        <span class="n">run</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">rails</span> <span class="p">?</span> <span class="s1">&#39;unicorn_rails&#39;</span> <span class="p">:</span> <span class="s1">&#39;unicorn&#39;</span><span class="si">}</span><span class="s2"> -D -c config/unicorn.rb -E </span><span class="si">#{</span><span class="n">env</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>                                             <span class="k">if</span> <span class="n">is_first_deploy</span>
      <span class="no">Tty</span><span class="o">.</span><span class="n">okay</span> <span class="s2">&quot;Reloading unicorn&quot;</span> <span class="k">do</span>
        <span class="n">run</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">rails</span> <span class="p">?</span> <span class="s1">&#39;unicorn_rails&#39;</span> <span class="p">:</span> <span class="s1">&#39;unicorn&#39;</span><span class="si">}</span><span class="s2"> -D -C config/unicorn.rb&quot;</span>
      <span class="k">end</span>                                             <span class="k">unless</span> <span class="n">is_first_deploy</span>
      <span class="no">Tty</span><span class="o">.</span><span class="n">okay</span> <span class="s2">&quot;Reloading nginx&quot;</span> <span class="k">do</span>
        <span class="n">sudo</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">nginx_bin</span><span class="si">}</span><span class="s2"> reload&quot;</span>
      <span class="k">end</span>                                             <span class="k">if</span> <span class="n">is_first_deploy</span>

    <span class="k">else</span> <span class="no">Tty</span><span class="o">.</span><span class="n">onoe</span><span class="p">(</span><span class="s2">&quot;Unknown command. Run &#39;her help&#39; for usage.&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">load_inline_files!</span>
    <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="n">her_files</span><span class="p">(</span><span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
  
    <span class="o">::</span><span class="no">DATA</span><span class="o">.</span><span class="n">each_line</span> <span class="k">do</span> <span class="o">|</span><span class="n">ln</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">ln</span> <span class="o">=~</span> <span class="sr">/^@@\s*(.*\S)\s*$/</span>
        <span class="n">her_files</span><span class="o">[</span><span class="vg">$1</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">=</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
      <span class="k">else</span>
        <span class="n">file</span> <span class="o">&lt;&lt;</span> <span class="n">ln</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">enable_options</span><span class="p">(</span><span class="o">*</span><span class="n">opts</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">op</span><span class="o">|</span> <span class="nb">eval</span><span class="s2">&quot;def </span><span class="si">#{</span><span class="n">op</span><span class="si">}</span><span class="s2">(v = @</span><span class="si">#{</span><span class="n">op</span><span class="si">}</span><span class="s2">, &amp;b); @</span><span class="si">#{</span><span class="n">op</span><span class="si">}</span><span class="s2"> = b || v; end&quot;</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="n">enable_options</span> <span class="ss">:server</span><span class="p">,</span> <span class="ss">:server_port</span><span class="p">,</span> <span class="ss">:server_user</span><span class="p">,</span>
                 <span class="ss">:repository</span><span class="p">,</span> <span class="ss">:branch</span><span class="p">,</span>
                 <span class="ss">:app_url</span><span class="p">,</span> <span class="ss">:app_name</span><span class="p">,</span>
                 <span class="ss">:deploy_base</span><span class="p">,</span>
                 <span class="ss">:nginx_bin</span><span class="p">,</span> <span class="ss">:nginx_config</span><span class="p">,</span>
                 <span class="ss">:on_deploy</span><span class="p">,</span> <span class="ss">:on_first_deploy</span><span class="p">,</span> <span class="ss">:is_first_deploy</span><span class="p">,</span>
                 <span class="ss">:rails</span><span class="p">,</span> <span class="ss">:env</span><span class="p">,</span>
                 <span class="ss">:visual_mode</span><span class="p">,</span> <span class="ss">:her_files</span>
<span class="k">end</span>

<span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span> <span class="o">==</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vg">$0</span><span class="p">)</span>
  <span class="n">args</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">dup</span>
  <span class="no">ARGV</span><span class="o">.</span><span class="n">clear</span>

  <span class="kp">include</span> <span class="no">Her</span>
  <span class="n">load_inline_files!</span>
  <span class="nb">exec</span><span class="o">!</span> <span class="n">args</span>
<span class="k">end</span>

<span class="cp">__END__</span>

<span class="cp">@@ help</span>
<span class="cp">Usage: her &lt;command&gt; [-v] ...</span>

<span class="cp">init                  # Generate configuration files (run once)</span>
<span class="cp">deploy                # Deploy to server</span>
<span class="cp">rake &lt;task&gt; &lt;tast&gt;    # Run rake command on the server</span>

<span class="cp">== Others ==</span>
<span class="cp">help                  # Show this screen</span>
<span class="cp">version               # Show version number</span>

<span class="cp">@@ her.rb</span>
<span class="cp">server      &quot;myserver.com&quot;</span>
<span class="cp">repository  &quot;git@github.com:pitr/rails3-app.git&quot;</span>
<span class="cp">app_url     &quot;myapp.company.com&quot;</span>
<span class="cp">app_name    &quot;myapp&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p> By default we deploy to /var/www
 deploy_base &ldquo;/var/www&rdquo;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">on_deploy do</span>
<span class="cp">  run &quot;bundle install --deployment&quot;</span>
<span class="cp">  run &quot;RAILS_ENV=production rake db:migrate&quot;</span>
<span class="cp">end</span>

<span class="cp">on_first_deploy do</span>
<span class="cp">  run &quot;RAILS_ENV=production rake db:seed&quot;</span>
<span class="cp">end</span>

<span class="cp">@@ unicorn.rb</span>
<span class="cp">APP_PATH = Dir.pwd + &#39;/&#39;</span>

<span class="cp">worker_processes 4</span>

<span class="cp">working_directory APP_PATH</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p> listen on both a Unix domain socket and a TCP port,
 we use a shorter backlog for quicker failover when busy</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">listen APP_PATH + &quot;tmp/.sock&quot;, :backlog =&gt; 64</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p> nuke workers after 30 seconds instead of 60 seconds (the default)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">timeout 30</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p> feel free to point this anywhere accessible on the filesystem</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">pid APP_PATH + &quot;tmp/pids/unicorn.pid&quot;</span>

<span class="cp">stderr_path APP_PATH + &quot;log/unicorn.stderr.log&quot;</span>
<span class="cp">stdout_path APP_PATH + &quot;log/unicorn.stdout.log&quot;</span>

<span class="cp">preload_app true</span>

<span class="cp">GC.respond_to?(:copy_on_write_friendly=) and GC.copy_on_write_friendly = true</span>

<span class="cp">before_fork do |server, worker|</span>
<span class="cp">  defined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect!</span>
<span class="cp">end</span>

<span class="cp">after_fork do |server, worker|</span>
<span class="cp">  defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection</span>
<span class="cp">end</span>

<span class="cp">@@ nginx_config</span>
<span class="cp">upstream #{app_name}_server {</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p> This is the socket we configured in unicorn.rb</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">   server unix:#{File.expand_path(deploy_base)}/#{app_name}/tmp/sockets/unicorn.sock</span>
<span class="cp">   fail_timeout=0;</span>
<span class="cp">}</span>

<span class="cp">server {</span>
<span class="cp">    listen 80;</span>
<span class="cp">    server_name #{server};</span>

<span class="cp">    keepalive_timeout 5;</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p> Location of our static files</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">    root #{File.expand_path(deploy_base)}/#{app_name}/public;</span>

<span class="cp">    location / {</span>
<span class="cp">      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span>
<span class="cp">      proxy_set_header Host $http_host;</span>
<span class="cp">      proxy_redirect off;</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p> If you don&rsquo;t find the filename in the static files
 Then request it from the telus_unicorn server</p>

      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">      if (!-f $request_filename) {</span>
<span class="cp">        proxy_pass http://#{app_name}_server;</span>
<span class="cp">        break;</span>
<span class="cp">      }</span>
<span class="cp">    }</span>

<span class="cp">    error_page 500 502 503 504 /500.html;</span>
<span class="cp">    location = /500.html {</span>
<span class="cp">      root #{File.expand_path(deploy_base)}/#{app_name}/public;</span>
<span class="cp">    }</span>
<span class="cp">}</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
